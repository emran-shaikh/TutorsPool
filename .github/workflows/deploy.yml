name: ğŸš€ Deploy TutorsPool

on:
  push:
    branches: [ main, production ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18'
  FIREBASE_PRIORITY: true

jobs:
  security-check:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸš« Check for sensitive files
        run: |
          if [ -f "firebase-admin-key.json" ]; then
            echo "âŒ ERROR: firebase-admin-key.json found in repository!"
            echo "This file should be in .gitignore and never committed"
            exit 1
          fi
          
          if [ -f ".env" ]; then
            echo "âŒ ERROR: .env file found in repository!"
            echo "This file should be in .gitignore and never committed"
            exit 1
          fi
          
          if grep -r "AIzaSy\|sk_live\|sk_test" --exclude-dir=node_modules --exclude=*.md .; then
            echo "âŒ ERROR: Hardcoded secrets found in code!"
            exit 1
          fi
          
          echo "âœ… Security check passed"

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ§ª Run tests
        run: npm test --if-present
      
      - name: ğŸ” TypeScript check
        run: npx tsc --noEmit

  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [security-check, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ”§ Set Firebase environment variables
        run: |
          echo "VITE_NODE_ENV=production" >> .env
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" >> .env
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}" >> .env
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}" >> .env
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}" >> .env
      
      - name: ğŸ—ï¸ Build frontend
        run: npm run build
      
      - name: ğŸ“¦ Package build artifacts
        run: |
          tar -czf frontend-build.tar.gz dist/ public/
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend-build.tar.gz

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: .
      
      - name: ğŸ“‚ Extract build
        run: tar -xzf frontend-build.tar.gz
      
      # Deploy to Vercel
      - name: âš¡ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        if: ${{ secrets.VERCEL_ORG_ID && secrets.VERCEL_PROJECT_ID }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod'
          env-vars: |
            NODE_ENV:production
            USE_FIREBASE:true
            USE_SUPABASE:false
            FIREBASE_PROJECT_ID:${{ secrets.FIREBASE_PROJECT_ID }}
            FIREBASE_PRIVATE_KEY:${{ secrets.FIREBASE_PRIVATE_KEY }}
            FIREBASE_PRIVATE_KEY_ID:${{ secrets.FIREBASE_PRIVATE_KEY_ID }}
            FIREBASE_CLIENT_EMAIL:${{ secrets.FIREBASE_CLIENT_EMAIL }}
            FIREBASE_CLIENT_ID:${{ secrets.FIREBASE_CLIENT_ID }}
            FIREBASE_AUTH_URI:${{ secrets.FIREBASE_AUTH_URI }}
            FIREBASE_TOKEN_URI:${{ secrets.FIREBASE_TOKEN_URI }}
            STRIPE_SECRET_KEY:${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY:${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            STRIPE_WEBHOOK_SECRET:${{ secrets.STRIPE_WEBHOOK_SECRET }}
            JWT_SECRET:${{ secrets.JWT_SECRET }}
            GOOGLE_MAPS_API_KEY:${{ secrets.GOOGLE_MAPS_API_KEY }}
      alternate:
        # Alternative deployment options
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
    
    # Heroku deployment alternative
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to Heroku
        if: ${{ secrets.HEROKU_API_KEY }}
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        run: |
          echo "ğŸš€ Deploying to Heroku..."
          # Add Heroku deployment commands here

  deploy-preview:
    name: ğŸ‘€ Deploy Preview
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
    
      - name: ğŸ“‚ Extract build
        run: tar -xzf frontend-build.tar.gz
      
      # Deploy preview to Vercel
      - name: ğŸ‘€ Deploy preview to Vercel
        uses: amondnet/vercel-action@v25
        if: ${{ secrets.VERCEL_ORG_ID && secrets.VERCEL_PROJECT_ID }}
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod'
          pr-no: ${{ github.event.pull_request.number }}
      
      - name: ğŸ’¬ Comment deployment URL
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ğŸš€ **Preview deployment ready!**
            
            **Preview URL:** https://your-app-git-${{ github.event.pull_request.head.ref }}-your-team.vercel.app
            
            **Firebase Configuration:** âœ… Secure environment variables loaded
            
            **Security Status:** 
            - âœ… No hardcoded secrets
            - âœ… Firebase Admin SDK secure
            - âœ… Environment variables configured

  notify-success:
    name: âœ… Notify Success
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¢ Notify deployment success
        if: github.event_name == 'push'
        run: |
          echo "ğŸ‰ TutorsPool deployed successfully!"
          echo "ğŸ”’ Firebase configuration secure"
          echo "ğŸ“Š Environment: production"
          echo "ğŸŒ Application ready at: https://your-domain.com"

  notify-failure:
    name: âŒ Notify Failure
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ğŸš¨ Notify deployment failure
        run: |
          echo "âŒ TutorsPool deployment failed"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ”’ Verify all required secrets are set in GitHub"
